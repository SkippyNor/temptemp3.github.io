<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>bash build standalone script | temptemp3.github.io</title>


<link rel="canonical" href="https://temptemp3.github.io/bash-build-standalone-script.html" />
<link rel="stylesheet" href="css/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<style>
body,h1,h2,h3,h4,h5 {font-family: "Raleway", sans-serif}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-104620931-1', 'auto');
  ga('send', 'pageview');
</script>
</head>
<body class="w3-light-grey">
<div class="w3-content" style="max-width:1400px">

<header class="w3-container w3-center w3-padding-32"> 
<h1><b><a style="text-decoration:none;" href="https://temptemp3.github.io/">tempt2<sup>3</sup></a></b></h1>
<p>Welcome to the blog of <span class="w3-tag"><a style="text-decoration:none;" href="https://github.com/temptemp3">temptemp3</a></span></p>
</header>

<div class="w3-row">
<div class="w3-col l8 s12">
<div class="w3-card-4 w3-margin w3-white">
<div class="w3-container">
<h1>bash build standalone script</h1>

<!--
[bash build standalone script](bash-build-standalone-script.html)
-->

<hr />

<p>Suppose that you have useful codebase of <a href="bash.html">bash</a> programs that you use in every script you write from start to finish. I do ; ) <br />
See <a href="https://github.com/temptemp3/sh2">sh2</a> if you are interested.</p>

<p>If you do, then it is likely that code you deliver may not be usable without running a block of command lines in the quickstart of the README.md in your repository. The typically client, even those you happen to be writing code for don't get this far. </p>

<p>A couple days after sending your first code submission, the client sends you a message in reply with this error.</p>

<pre><code>bash: commands: command not found
</code></pre>

<p>Before looking I thought, what could it be?</p>

<p>As it turns out, I forgot to instruct the client to install sh2 which would fix the error and allow <code>.</code> source lines to work.</p>

<p>Since it is a little past due for that I came up with a workaround, have the program generate a standalone version of itself. Why not? (This time around I didn't create a repo to reduce overhead allow for flexibility while developing a solution to the clients problem.)</p>

<p>It took a few minutes after to get it to work as expected. I even managed to <a href="https://github.com/temptemp3/sh2/commit/0a9a64703d440fff20f55d9bd83a20905f52a993">commit</a> minor changes in related files in the branch of sh2 I use. Right on.</p>

<p>Eventually, a new build of the script was sent out to the client.. And now I have to figure out what to do with this new build command I cooked up. For starters, I decided to write about how to build standalone bash scripts from otherwise complicated scripts containing multiple <code>.</code> lines sourcing in reusable code. And here we are.</p>

<p>Since using my code I wrote for the client as an example or even snippets of that code wouldn't seem ethical, I put threw together a script from scratch.</p>

<pre><code>clipboy make:function test-build-standalone
</code></pre>

<p>Then, with a little work I came up with the following bash program, just enough to understand without the evils of premature optimization. A eviler version may be added to sh2 in the future.</p>

<p>Here is what it looks like.</p>

<pre><code>#!/bin/bash
## test-build-standalone
## version 0.0.1 - initial
## ToDo:
## - reject build if same as last
## - handle case of build building itself
## + may exceed limitation on filename length
##################################################
. ${SH2}/aliases/commands.sh
. ${SH2}/cecho.sh
test-build-standalone-build() {
  local outfile
  outfile="${build}/$( basename ${0} .sh )-$( date +%y%m%dT%H%M ).sh"
  cecho green "building standalone ..."
  ################################################
  ## 1.  cleanup build (creates empty build dir)
  ## 1.  populate build (minimum: source script)
  ## 1.1 migrate script
  ################################################
  ## 1. cleanup build (creates empty build dir)
  ################################################
  cecho green "cleanup up build ..."
  cecho yellow $( test ! -d "${build}" || rm -rvf ${_} )
  cecho yellow $( mkdir -v "${build}" )
  cecho green "build clean"
  ################################################
  ## 1. populate build (minimum: source script)
  ################################################
  ## 1.1 migrate script
  ## - resolves '.' lines
  ## - keeps 'source' lines
  ################################################
  { # resolve source lines
    bash -vp ${0} true 2>&1 | 
    grep -v -e '^\s*[.]\s\+' 
  } | tee ${outfile}
  ################################################
  cecho green "standalone built"
}
test-build-standalone-true() {
  true
}
test-build-standalone() {
  local build
  build=${build_dir-build}
  commands
}
##################################################
if [ ! ] 
then
 true
else
 exit 1 # wrong args
fi
##################################################
test-build-standalone ${@}
##################################################
## generated by create-stub2.sh v0.1.2
## on Tue, 23 Apr 2019 08:43:13 +0900
## see <https://github.com/temptemp3/sh2>
##################################################
</code></pre>

<p>Using the build command, the script can convert itself to a standalone script by resolving <code>.</code> lines.</p>

<p>Here is the standalone version.</p>

<pre><code>#!/bin/bash
## test-build-standalone
## version 0.0.1 - initial
##################################################
#!/bin/bash
## commands (alias)
## - function command cli adapter
## version 0.0.6 - enable alias expansion for standalone use
##################################################
list-available-commands() { { local function_name ; function_name="${1}" ; local filter_include ; filter_include="${2}" ; }
 echo available commands:
 declare -f \
   | grep -e "^${function_name}" \
   | cut "-f1" "-d " \
   | grep -v -e "which" -e "for-each" -e "payload" -e "initialize" \
   | sed -e "s/${function_name}-//" \
   | xargs -I {} echo "- {}" \
   | sed  "1d" \
   | grep -e "${filter_include}"
}
shopt -s expand_aliases
alias read-command-args='
 list-available-commands ${FUNCNAME}
 echo "enter new command (or q to quite)"
 read command_args
'
alias parse-command-args='
 _car() { echo ${1} ; }
 _cdr() { echo ${@:2} ; }
 _command=$( _car ${command_args} )
 _args=$( _cdr ${command_args} )
'
alias commands='
 #test "${_command}" || { local _command ; _command="${1}" ; }
 #test "${_args}" || { local _args ; _args=${@:2} ; }
 { local _command ; _command="${1}" ; }
 { local _args ; _args=${@:2} ; }
 test ! "$( declare -f ${FUNCNAME}-${_command} )" && {
  {    
    test ! "${_command}" || {
     echo "${FUNCNAME} command \"${_command}\" not yet implemented"
    }
    list-available-commands ${FUNCNAME} 
  } 1>&2
 true
 } || {
  ${FUNCNAME}-${_command} ${_args}
 }
'
alias run-command='
 {
   commands
 } || true
'
alias handle-command-args='
 case ${command_args} in
   q|quit) {
    break  
   } ;; 
   *) { 
    parse-command-args
   } ;;
 esac
'
alias command-loop='
 while [ ! ]
 do
  run-command
  read-command-args
  handle-command-args
 done
'
##################################################
#!/bin/bash
## cecho
## - color echo
## version 0.0.1 - mute on absent line
##################################################
cecho-color() { #{ local candidate_color ; candidate_color="${1}" ; }
 case ${candidate_color} in
  blue) {
   echo 34 
  } ;;
  yellow) {
   echo 33
  } ;;
  green) {
   echo 32 
  } ;; 
  *) {
   echo 0
  } ;;
 esac
}
#-------------------------------------------------
cecho() { { local candidate_color ; candidate_color="${1}" ; local line ; line=${@:2} ; }
  test ! "${line}" || {
    echo -e "\e[$( ${FUNCNAME}-color )m ${line} \e[0m" 
  } 1>&2
}
##################################################
if [ ! ] 
then
 true
else
 exit 1 # wrong args
fi
##################################################
cecho ${@}
##################################################
test-build-standalone-build() {
  local outfile
  outfile="${build}/$( basename ${0} .sh )-$( date +%y%m%dT%H%M ).sh"
  cecho green "building standalone ..."
  ################################################
  ## 1.  cleanup build (creates empty build dir)
  ## 1.  populate build (minimum: source script)
  ## 1.1 migrate script
  ################################################
  ## 1. cleanup build (creates empty build dir)
  ################################################
  cecho green "cleanup up build ..."
  cecho yellow $( test ! -d "${build}" || rm -rvf ${_} )
  cecho yellow $( mkdir -v "${build}" )
  cecho green "build clean"
  ################################################
  ## 1. populate build (minimum: source script)
  ################################################
  ## 1.1 migrate script
  ## - resolves '.' lines
  ## - keeps 'source' lines
  ################################################
  { # resolve source lines
    bash -vp ${0} true 2>&1 | 
    grep -v -e '^\s*[.]\s\+' 
  } | tee ${outfile}
  ################################################
  cecho green "standalone built"
}
test-build-standalone-true() {
  true
}
test-build-standalone() {
  local build
  build=${build_dir-build}
  commands
}
##################################################
if [ ! ] 
then
 true
else
 exit 1 # wrong args
fi
##################################################
test-build-standalone ${@}
##################################################
## generated by create-stub2.sh v0.1.2
## on Tue, 23 Apr 2019 08:43:13 +0900
## see <https://github.com/temptemp3/sh2>
##################################################
</code></pre>

<p><strong>Bottom line</strong></p>

<p>It is possible to have a bash script build standalone bash scripts from itself or other bash scripts. It may serve as an effective code delivery practice. The <code>build</code> command may be developed further.</p>

<hr />
</div>
</div>
</div>
<div class="w3-col l4">
<div class="w3-card-2 w3-margin w3-margin-top w3-white">
<div class="w3-container">
<div class="w3-bar w3-white">
<a href="index.html" class="w3-bar-item w3-button w3-mobile">index</a>
<a href="bash-build-standalone-script.html" class="w3-bar-item w3-button w3-mobile">bash-build-standalone-script</a>
<a href="core-hours.html" class="w3-bar-item w3-button w3-mobile">core-hours</a>
</div> 
</div>
</div>
</div>
</div>

</div>
<footer class="w3-container w3-dark-grey w3-padding-32 w3-margin-top">
<p>&copy; 2017-2019 <a href="https://temptemp3.github.io/">temptemp3.github.io</a><br>
Built with <a href="https://github.com/temptemp3/sh2/blob/180702/u2.sh">u2.sh</a> Default theme and Vim</p>
<!--button class="w3-button w3-black w3-disabled w3-padding-large w3-margin-bottom">Previous</button>
<button class="w3-button w3-black w3-padding-large w3-margin-bottom">Next</button-->


</footer>
</body>
</html>
